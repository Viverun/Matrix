"""
Vulnerability database model.
"""
from datetime import datetime
from enum import Enum
from sqlalchemy import Column, Integer, String, Text, Float, DateTime, ForeignKey, JSON, Boolean
from sqlalchemy import Enum as SQLEnum
from sqlalchemy.orm import relationship
from core.database import Base


class Severity(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityType(str, Enum):
    """Types of vulnerabilities detected."""
    SQL_INJECTION = "sql_injection"
    XSS_REFLECTED = "xss_reflected"
    XSS_STORED = "xss_stored"
    XSS_DOM = "xss_dom"
    CSRF = "csrf"
    IDOR = "idor"
    AUTH_BYPASS = "auth_bypass"
    BROKEN_AUTH = "broken_auth"
    SENSITIVE_DATA = "sensitive_data"
    SECURITY_MISCONFIG = "security_misconfig"
    INJECTION_OTHER = "injection_other"
    BROKEN_ACCESS = "broken_access"
    SSRF = "ssrf"
    COMMAND_INJECTION = "command_injection"
    XXE = "xxe"
    INSECURE_DESERIALIZATION = "insecure_deserialization"
    FILE_UPLOAD = "file_upload"
    PATH_TRAVERSAL = "path_traversal"
    OPEN_REDIRECT = "open_redirect"
    INFO_DISCLOSURE = "info_disclosure"
    OTHER = "other"


class Vulnerability(Base):
    """Detected vulnerability model."""
    
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # Classification
    vulnerability_type = Column(SQLEnum(VulnerabilityType), nullable=False)
    severity = Column(SQLEnum(Severity), nullable=False)
    cvss_score = Column(Float, nullable=True)  # 0.0 - 10.0
    
    # Location
    url = Column(String(2048), nullable=False)
    parameter = Column(String(255), nullable=True)
    method = Column(String(10), default="GET")  # GET, POST, PUT, DELETE
    
    # Risk Assessment
    likelihood = Column(Float, default=0.0)  # 0.0 - 10.0
    impact = Column(Float, default=0.0)      # 0.0 - 10.0
    exploitability_rationale = Column(Text, nullable=True)
    
    # Details
    title = Column(String(500), nullable=False)
    description = Column(Text, nullable=False)
    evidence = Column(Text, nullable=True)  # Proof of vulnerability
    
    # Request/Response data
    request_data = Column(JSON, nullable=True)
    response_snippet = Column(Text, nullable=True)
    
    # AI Analysis
    ai_confidence = Column(Float, default=0.0)  # 0-100
    ai_analysis = Column(Text, nullable=True)
    
    # Remediation
    remediation = Column(Text, nullable=True)
    remediation_code = Column(Text, nullable=True)
    reference_links = Column(JSON, default=list)
    
    # OWASP Mapping
    owasp_category = Column(String(100), nullable=True)
    cwe_id = Column(String(20), nullable=True)
    
    # Status
    is_false_positive = Column(Boolean, default=False)
    is_verified = Column(Boolean, default=False)
    is_fixed = Column(Boolean, default=False)
    is_suppressed = Column(Boolean, default=False)
    suppression_reason = Column(Text, nullable=True)
    
    # Final Verdict Layer
    final_verdict = Column(String(50), nullable=True)  # FALSE_POSITIVE, ACTION_REQUIRED, etc.
    action_required = Column(Boolean, default=True)
    detection_confidence = Column(Float, default=0.0)
    exploit_confidence = Column(Float, default=0.0)
    
    # Scope & Impact
    scope_impact = Column(JSON, nullable=True)  # { "endpoints": 3, "methods": ["GET"], "systemic": true }
    
    # Agent that detected it
    detected_by = Column(String(100), nullable=True)
    
    # Timestamps
    detected_at = Column(DateTime, default=datetime.utcnow)
    verified_at = Column(DateTime, nullable=True)
    
    # Relationships
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=False)
    scan = relationship("Scan", back_populates="vulnerabilities")
    
    def __repr__(self):
        return f"<Vulnerability {self.title} ({self.severity.value})>"
    
    def to_dict(self):
        """Convert to dictionary for API responses."""
        return {
            "id": self.id,
            "type": self.vulnerability_type.value,
            "severity": self.severity.value,
            "cvss_score": self.cvss_score,
            "url": self.url,
            "parameter": self.parameter,
            "method": self.method,
            "title": self.title,
            "description": self.description,
            "evidence": self.evidence,
            "ai_confidence": self.ai_confidence,
            "remediation": self.remediation,
            "owasp_category": self.owasp_category,
            "cwe_id": self.cwe_id,
            "detected_by": self.detected_by,
            "detected_at": self.detected_at.isoformat() if self.detected_at else None,
            "likelihood": self.likelihood,
            "impact": self.impact,
            "exploitability_rationale": self.exploitability_rationale,
            "final_verdict": self.final_verdict,
            "action_required": self.action_required,
            "detection_confidence": self.detection_confidence,
            "exploit_confidence": self.exploit_confidence,
            "is_suppressed": self.is_suppressed,
            "suppression_reason": self.suppression_reason,
            "scope_impact": self.scope_impact,
        }
